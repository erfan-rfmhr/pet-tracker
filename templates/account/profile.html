{% extends 'Pages/Shared/_Layout.html' %}
{% block PageContent %}
    {% load static %}
    <div id="page-content">
        <div class="row">
            <!-- BEGIN BREADCRUMB -->
            <div class="col-md-12">
                <div class="breadcrumb-box border shadow">
                    <ul class="breadcrumb">
                        <li><a id="ttlPage" href="#">Profile</a></li>
                    </ul>
                    <div class="breadcrumb-right">

                    <span class="dateToday">
                        Fri, 26 Aug 2022
                    </span>
                        <i class="icon-calendar"></i>
                    </div><!-- /.breadcrumb-right -->
                </div><!-- /.breadcrumb-box -->
            </div><!-- /.col-md-12 -->
            <!-- END BREADCRUMB -->
        </div>


        <div id="recordDetail" class="row justify-content-center">


            <div class="col-lg-7 col-12">
                <div class="portlet box border shadow">

                    <div class="portlet-body">


                        <div class="row">

                            <div class="col-12">
                                <div class="tab-content">
                                    <div class="tab-pane active" id="tab23">
                                        <fieldset>
                                            <input type="hidden" id="hfId"/>
                                            <form id="form1" method="POST" role="form">
                                                {% csrf_token %}

                                                <div class="row">

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-group">
                                                            <label>{{ form.first_name.label_tag }}</label>
                                                            <div class="input-group">
                                                                {{ form.first_name }}
                                                            </div><!-- /.input-group -->
                                                        </div><!-- /.form-group -->
                                                    </div>

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-group">
                                                            <label>{{ form.last_name.label_tag }}</label>
                                                            <div class="input-group">
                                                                {{ form.last_name }}
                                                            </div><!-- /.input-group -->
                                                        </div><!-- /.form-group -->
                                                    </div>

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-group">
                                                            <label>{{ form.username.label_tag }}</label>
                                                            <div class="input-group">
                                                                {{ form.username }}
                                                            </div><!-- /.input-group -->
                                                        </div><!-- /.form-group -->
                                                    </div>
                                                </div>


                                                <div class="form-actions text-center mt-3">


                                                    <button id="btnSave1" type="submit"
                                                            class="btn btn-success btn-curve">
                                                        <i class="icon-check"></i>
                                                        Confrim
                                                    </button>

                                                </div>


                                    </div>
                                    </form>
                                    </fieldset>
                                </div><!-- /.tab-pane -->


                            </div><!-- /.tab-content -->
                        </div><!-- /.col-9 -->
                    </div><!-- /.row -->


                </div><!-- /.portlet-body -->
            </div><!-- /.portlet -->
        </div><!-- /.col-lg-8 -->

    </div>


    </div><!-- /#page-content -->

    <style>
        .error, .has-error + .help-block, .has-error .checkbox, .has-error .checkbox-inline, .has-error .control-label, .has-error .help-block, .has-error .radio, .has-error .radio-inline, .has-error.checkbox label, .has-error.checkbox-inline label, .has-error.radio label, .has-error.radio-inline label {
            color: #f55145;

        }
    </style>

    <link href="{% static 'assets/plugins/data-table/css/jquery.dataTables.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'assets/plugins/data-table/css/buttons.dataTables.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'assets/plugins/select2/dist/css/select2.min.css' %}" rel="stylesheet">

    <script>

        $("#usersMyRofile").addClass("current");

        function openMyFileDialog(inputId) {
            $("#" + inputId).click();
            return false;
        }


        getData_Edit($('input:hidden[name="__RequestVerificationToken"]').val());

        function getData_Edit(mToken) {

            $.ajax({
                type: "POST",
                async: true,
                url: "/profile?handler=MyPatientData",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        mToken);

                },

                success: function (response) {

                    let mdata = response.user;
                    $("#hfId").val(mdata.Id);
                    $("#txtName").val(mdata.Name);
                    $("#txtFamily").val(mdata.Family);
                    $("#txtUserName").val(mdata.UserName);
                    $("#txtPass").val(mdata.Pass);
                    $("#txtexpireDate").val(mdata.expireDate);
                    $("#txtimg").val(mdata.img);

                    var output = document.getElementById('imgP');


                    output.src = "/assets/Images/user/" + mdata.img;
                    //$("#imgP").show();

                    $("#cmbRole").val(mdata.Role).change();


                    $('#ttlPage').text("Edit Profile");


                },
                failure: function (response) {
                    swal({
                        type: 'error',
                        title: 'error',
                        text: 'error',
                        timer: 2000
                    }).catch(swal.noop);

                    //alert(response.responseText);
                },
                error: function (response) {

                    swal({
                        type: 'error',
                        title: 'error',
                        text: 'error',
                        timer: 2000
                    }).catch(swal.noop);
                }
            });
        }


        $("#btnSave1").click(function () {
            if ($('#form1').valid()) {


                $("#btnSave1").prop('disabled', true);

                let myoutput = document.getElementById('imgP');


                var dd = {

                    Name: $("#txtName").val(),
                    Family: $("#txtFamily").val(),
                    UserName: $("#txtUserName").val(),
                    Pass: $("#txtPass").val(),
                    expireDate: $("#txtexpireDate").val(),
                    //img: $("#txtimg").val(),
                    img: myoutput.src.split('/').pop(),
                    Role: $("#cmbRole").val()


                };
                Crud_Sec1($('input:hidden[name="__RequestVerificationToken"]').val(), dd);


            } else {
                return false;
            }
        });


        function Crud_Sec1(mToken, mData) {

            $.ajax({
                type: "POST",
                async: true,
                url: "/profile?handler=Crud_Sec1",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        mToken);

                },
                data: mData,
                success: function (response) {


                    if (response.res) {
                        //alert(response.Id);


                        $("#hfId").val("");

                        var output = document.getElementById('imgP');

                        var output1 = document.getElementById('imgProfile1');
                        var output2 = document.getElementById('imgProfile2');
                        output1.src = output.src;
                        output2.src = output.src;

                        //$('#mytabs a[href="#tab23"]').tab('show');


                        $("#btnSave1").prop('disabled', false);


                        swal({
                            type: 'success',
                            title: 'Success',
                            text: 'Changes saved successfully',
                            timer: 6000
                        }).catch(swal.noop);
                    } else {


                        //alert("Y");
                        swal({
                            type: 'error',
                            title: 'Error',
                            text: response.msg,
                            timer: 6000
                        }).catch(swal.noop);
                        $("#btnSave1").prop('disabled', false);

                    }


                },
                failure: function (response) {
                    swal({
                        type: 'error',
                        title: 'error',
                        text: 'error',
                        timer: 6000
                    }).catch(swal.noop);
                    $("#btnSave1").prop('disabled', false);

                    //alert(response.responseText);
                },
                error: function (response) {

                    swal({
                        type: 'error',
                        title: 'error',
                        text: 'error',
                        timer: 6000
                    }).catch(swal.noop);
                    $("#btnSave1").prop('disabled', false);
                }
            });
        }


        $('.FuncUploadFiles').change(function (event) {

            var ub = {};

            var p1 = $("#hfId").val();
            var name1 = "";


            var input = document.getElementById('fileUpl');

            //var btnDelFile = document.getElementById(btnDelFileId);
            var files = input.files;
            if (!files[0].type.match(/image.*/)) {
                alert('This file format cannot be uploaded');
                return false;
            }
            if (files[0].size > 5242880) {

                alert("The maximum file size is 2 MB");
                return false;
            }

            var reader = new FileReader();


            var output = document.getElementById('imgP');

            var formData = new FormData();


            for (var i = 0; i != files.length; i++) {
                formData.append("files", files[i]);
                formData.append('mid', "0");
                /*  formData.append('s3', ub.s3);*/
                formData.append('pId', "1");

            }

            $.ajax(
                {
                    //url: "/api/Values/upload2",
                    url: "/Users?handler=UploadImage",
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("XSRF-TOKEN",
                            $('input:hidden[name="__RequestVerificationToken"]').val());
                    },


                    data: formData,

                    processData: false,
                    contentType: false,
                    type: "POST",
                    success: function (data) {
                        $("#" + 'fileProgress').hide();

                        output.src = data.url;
                        $("#" + 'imgP').show();

                    }
                    , xhr: function () {
                        var fileXhr = $.ajaxSettings.xhr();
                        if (fileXhr.upload) {
                            $("#" + 'fileProgress').show();
                            $("#" + 'imgP').hide();
                            //$("#" + btnDelFileId).hide();


                            fileXhr.upload.addEventListener("progress", function (e) {
                                if (e.lengthComputable) {
                                    console.log(e.loaded);
                                    console.log(e.total);
                                    $("#" + 'fileProgress').attr({
                                        value: e.loaded,
                                        max: e.total
                                    });
                                }
                            }, false);
                        }
                        return fileXhr;
                    }
                }
            );

        });
    </script>

{% endblock PageContent %}